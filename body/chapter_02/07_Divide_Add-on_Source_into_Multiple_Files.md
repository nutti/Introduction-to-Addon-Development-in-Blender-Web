<div id="sect_title_img_2_7"></div>

<div id="sect_title_text"></div>

# アドオンのソースコードを複数ファイルへ分割する

<div id="preface"></div>

###### アドオンへ機能を追加すると、嫌でもソースコードのサイズが肥大化します。ソースコードが肥大化し管理が大変になってきたら、ソースコードを複数ファイルに分割することを検討しましょう。本節では、アドオンのソースコードを複数ファイルへ分割する方法を紹介します。

## ソースコードを複数ファイルへ分割するメリット

ここまで紹介してきたサンプルのソースコードは、1つのファイルで構成されていました。
サンプルは非常に単純な機能しか持たないアドオンでしたので、ソースコードの行数も比較的少なく1つのファイルでも問題なく扱うことができました。
しかし、実用的なアドオンは本書で紹介しているアドオンよりも複雑な処理になることが多くなります。
そのような複雑な処理の機能全てが1つのソースコードだけに書かれていると、後からソースコードを修正したい時に修正箇所を見つけるのが大変です。

ソフトウェアの開発や文章に限らず一般的に言って、内容でファイルを分割することによりファイルの管理が楽になります。
アドオンの開発においても、ソースコードを複数のファイルへ分割することで、後からソースコードを修正する時に修正箇所をより早く見つけることができるようになります。


## 作成するアドオンの仕様

* [2-2節](../chapter_02/02_Register_Multiple_Operation_Classes.md) で紹介したサンプルと同じ機能を持つ
* 『*オブジェクト* > *選択オブジェクトの拡大*』の処理と『*オブジェクト* > *選択オブジェクトの縮小*』の処理を、複数のファイルへ分割する

## アドオンを作成する

[1-2節](../chapter_01/02_Use_Blender_Add-on.md) のBlenderアドオン用フォルダにディレクトリ名 ```sample_2-2``` のディレクトリを作成します。
[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして以下のソースコードをテキスト・エディタに入力し、作成したディレクトリの下にファイル名をそれぞれ ```__init__.py``` , ```enlarge_object.py``` , ```reduce_object.py``` として保存してください。

[import](../../sample/src/chapter_02/sample_2-7/__init__.py)

[import](../../sample/src/chapter_02/sample_2-7/enlarge_object.py)

[import](../../sample/src/chapter_02/sample_2-7/reduce_object.py)

## アドオンを使用する

### アドオンを有効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に作成したアドオンを有効化すると、コンソールに以下の文字列が出力されます。

```sh
サンプル2-7: アドオン「サンプル2-7」が有効化されました。
```

### アドオンの機能を使用する

アドオンの機能は、 [2-2節](../chapter_02/02_Register_Multiple_Operation_Classes.md) で紹介したサンプルと同じ機能ですので、そちらを参照ください。

### アドオンを無効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に有効化したアドオンを無効化すると、コンソールに以下の文字列が出力されます。

```sh
サンプル2-7: アドオン「サンプル2-7」が無効化されました。
```

## ソースコードの解説

### モジュールとパッケージ

ソースコードの解説の前に、Pythonのモジュールとパッケージの概念について理解しておく必要があります。

Pythonでは、 **クラスや関数、変数が定義された1つのスクリプトファイル** をモジュールといいます。
ソースコード内でモジュールをインポートすることによって、モジュールで定義したクラスや関数、変数が使用可能となります。

そして、 **複数のモジュールを1つにまとめたもの** をパッケージといいます。Pythonでパッケージを作成するためには、作成したディレクトリ配下に ```__init__.py``` というファイルとパッケージ化するモジュール一式を置きます。一般的に ```__init__.py``` は空ファイルですが、Blenderでパッケージを作る場合は後で説明するように、必要事項を記載する必要があります。

モジュール名とパッケージ名は、それぞれスクリプトファイル名とパッケージ作成したディレクトリとなります。
このことを踏まえて、本節のサンプルにおけるモジュールとパッケージの関係を整理すると、 **sample_2-7パッケージにはenlarge_objectモジュールとreduce_objectモジュールが含まれる** となります。

### \_\_init\_\_.py とは

本節で作成したサンプルのソースコードは3つのファイルから構成されます。
これら3つのファイルのうち最も重要なファイルは、 ```__init__.py``` です。
```__init__.py``` には、アドオン有効化時に実行される処理やモジュール（本節のサンプルでは、```enlarge_object.py``` , ```reduce_object.py```）の読み込み処理を記載します。

Pythonのパッケージを作ったことがある人であればわかると思いますが、 ```__init__.py``` にはパッケージインポート時に呼び出される処理を記載します。
このことからアドオンの有効化は、Blenderへのパッケージのインポートと同様であると考えることができます。

以降の解説では、 ```__init__.py``` を中心に解説していきます。
```enlarge_object.py``` , ```reduce_object.py``` に関する解説は [2-2節](../chapter_02/02_Register_Multiple_Operation_Classes.md) を参照ください。

### モジュールのインポート

モジュールのインポートは、 ```bpy``` モジュールを読み込んだ時と同様、 ```import``` 指示により行います。

```python
import enlarge_object
import reduce_object
```

しかし、これだけではアドオン有効化時に ```enlarge_object``` と ```reduce_object``` が見つからないとエラー出力されてしまいます。
これは、Blenderが ```enlarge_object``` と ```reduce_object``` の場所を知らないからです。

Blenderが ```enlarge_object``` と ```reduce_object``` の場所を知るために、以下のように書き換えます。

```python
from . import enlarge_object
from . import reduce_object
```

```from .``` を付け加えたことにより、 ```__init__.py``` が置かれたディレクトリ、つまり自身のパッケージの中から ```enlarge_object``` と ```reduce_object``` を探すようになります。
これで、アドオン有効化時のエラーは出力されなくなりました。
しかし、もう少しやるべきことがあります。

[1-5節](../chapter_01/05_Install_own_Add-on.md) では、Blenderを再起動せずにBlenderの機能である「Reload Scripts」の機能を用いて、アドオンをアップデートする方法を紹介しました。
実はこの機能を用いても、複数のファイルから構成されるアドオンをアップデートされない場合があります。
「Reload Scripts」機能を使った時に、 ```__init__.py``` でインポートしているモジュールの再読み込みに失敗していることが原因です。
```from  . import ...``` を用いてモジュールの再読み込みができると思うかもしれませんが、既にインポートされているモジュールに対するインポートは無視されます。

この問題に対処するため、以下のようにインポート処理を書き換える必要があります。

```python
if "bpy" in locals():
    import imp
    imp.reload(enlarge_object)
    imp.reload(reduce_object)
else:
    from . import enlarge_object
    from . import reduce_object

import bpy
```

上記のコードを簡単に説明します。
最初のif文では、 ```bpy``` モジュールが既にインポートされているかを判定します。
インポートされていなければ、Blender起動後初めてアドオンが読み込まれたと判定し、関連するモジュールをインポートします。

一方、 ```bpy``` モジュールが既にインポートされていれば、Blender起動後の2回目以降の読み込みであると判定します。
2回目以降の読み込みと判定された場合は ```imp``` モジュールを用いて、既にインポートされているモジュールを再度読み込みます。
2回目以降の読み込みと判定されるのは、「Reload Scripts」機能によりアドオンが再度読み込まれた時になるため、これはうまく動きます。

なお、 ```bpy``` モジュールのインポートは、モジュール読み込み処理の後でなければなりません。
もし ```bpy``` モジュールのインポートをモジュール読み込み処理の前に書いてしまうと、最初のif文で真と判定されてしまいます。

### bl_info 変数の作成

```__init__.py``` には、 ```bl_info``` 変数を記載する必要があります。
コードの内容は、 [2-1節](../chapter_02/01_Basic_of_Add-on_Development.md) と同じですので、ここでは説明を省略します。

### アドオン有効化・無効化時の処理

アドオンの有効化・無効化時呼ばれる、 ```register()``` 関数・ ```unregister()``` 関数についても ```__init__.py``` に記載する必要があります。

ソースコードの内容は、 [2-1節](../chapter_02/01_Basic_of_Add-on_Development.md) と同様ですので基本的にそちらを参照すれば問題ありませんが、1点異なることがあります。
```register()``` 関数や ```unregister()``` 関数で ```bpy.types.VIEW3D_MT_object.append()``` 関数に渡す関数 ```menu_fn()``` 関数を見てください。
```menu_fn()``` 関数の中で ```self.layout.operator()``` 関数が呼ばれていますが、引数に注目するとクラス名の前にモジュール名が追加されています。
```bpy``` モジュールと同様に ```enlarge_object``` もモジュールであるため、モジュール内のクラスや関数などにアクセスする場合は、モジュール名をつける必要があります。


### enlarge_object.py と reduce_object.py

```enlarge_object.py``` には ```EnlargeObject``` クラス、 ```reduce_object.py``` には ```ReduceObject``` クラスが記載されています。
ソースコードの内容については、 [2-1節](../chapter_02/01_Basic_of_Add-on_Development.md) を参照してください。


## まとめ

アドオンのソースコードを複数ファイルに分割する方法を紹介しました。
ソースコードの行数が増えると基本的にメンテナンスしにくくなる傾向がありますので、ある程度ソースコードの行数が増えてきたら複数のファイルに分割することを検討すべきです。
ソースコードを分割する目安は行数や機能など様々ですが、筆者はアドオンを機能単位に分割するように心がけています。そうすることで機能にちなんだファイル名をつけることができるようになりますし、モジュールも機能ごとに分かれるため、ソースコード内でモジュールを参照する時にきれいに書くことができるようになります。


<div id="point"></div>

### ポイント

<div id="point_item"></div>

* Pythonでは、クラスや関数、変数が定義された1つのスクリプトファイルをモジュールという
* Pythonでは、複数のモジュールを1つにまとめたものをパッケージという
* Pythonでパッケージを作成するためには、ディレクトリ配下に ```__init__.py``` とパッケージ化するモジュール一式を置く必要がある
* ```__init__.py``` には、アドオン有効化時に実行される処理やモジュールの読み込み処理を記載する
* アドオンを複数のファイルに分割する場合は、Blenderの機能『Reload Scripts』への対応に気をつけよう
* ソースコードの行数が増えると基本的にメンテナンスしにくくなる傾向がある。ソースコードの行数が増えてきたら複数のファイルに分割することを検討しよう
