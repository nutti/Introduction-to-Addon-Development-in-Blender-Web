---
pagetitle: 3-7. プリファレンスを活用する
subtitle: 3-7. プリファレンスを活用する
---

プリファレンスには、アドオンごとに提供されるアドオンの設定情報があります。
ユーザはこの設定情報から、アドオンが提供する設定内容を変更できます。
アドオン開発者は、アドオンの機能に割り当てるキーボードのキーやUIのフォントなど、ユーザに設定させたい情報をプリファレンスに配置できます。
プリファレンスを活用することで、Sidebarをはじめとした既存のUIの邪魔にならないように、アドオンの設定を変更するUIを提供できます。


# プリファレンス


## プリファレンスにおけるアドオン設定情報

**プリファレンス** とは、トップバーの *[編集]* > *[プリファレンス...]* から開くことのできるウィンドウを指します。
これまでの節では、プリファレンスを使ってBlenderのUIを日本語化したり、アドオンの有効/無効化を行ったりしてきました。
これらに加えて、アドオンの設定情報を配置できる場所が、プリファレンスに存在します。
ユーザは、プリファレンスに配置されたアドオンの設定を行うためのUIから、ユーザの好みに合わせてアドオンの設定を行います。

プリファレンス上にアドオンの設定情報を配置する方法を説明する前に、アドオンの設定情報が配置される場所を知っておく必要があります。
ここでは、筆者が作成したアドオン『Magic UV』を使って確認します。


<div class="work"></div>

|||
|---|---|
|1|トップバーの *[編集]* > *[プリファレンス...]* を実行して表示される *[プリファレンス]* で、*[アドオン]* タブを選択し、『Magic UV』を有効化した状態で左の矢印をクリックして、アドオンの詳細情報を表示します。<br>![](../../images/chapter_03/07_Use_Preference/preferences_1.png "プリファレンス 手順1")|
|2|*[プリファレンス:]* と書かれているところが、本節で説明するアドオンの設定情報の配置先になります。<br>![](../../images/chapter_03/07_Use_Preference/preferences_2.png "プリファレンス 手順2")|


## プリファレンスに追加すべきアドオン設定

これまで、アドオンの設定を変更するUIの配置場所として、Sidebarやオペレータプロパティを紹介しましたが、本節では新たに、プリファレンスと呼ばれる配置先が登場しました。
頻繁に変更しないアドオンの設定情報をプリファレンスに配置することで、SidebarやオペレータプロパティのUIが複雑になることを避けることができます。

プリファレンスに配置する情報として、適切だと考えられるものを次に示します。

* アドオンの機能に割り当てる、キーボードのキーやマウスのボタン
* [3-4節](04_Draw_Figures.html) や [3-5節](05_Draw_Texts.html) で紹介した、独自UIにおけるフォントなどのアドオンのUI設定
* 文字数の関係上、`bl_info` に記載できなかったアドオンの詳細情報（特に、`location` や `description` は長文になることが多い）
* アドオン内の機能の有効化/無効化（アドオンが複数の機能で構成される場合）
* アドオン全体で共有したい設定（アドオンが複数の機能で構成される場有）

本節のサンプルアドオンでは、上から2番目の用途で、プリファレンスにアドオンの設定を変更するUIを配置します。


# 作成するアドオンの仕様

本節では、[3-5節](05_Draw_Texts.html) で紹介したサンプルアドオンを改造します。

* [3-5節](05_Draw_Texts.html) のサンプルアドオンを改造し、テキストを描画する位置とテキストのフォントサイズを、プリファレンスから変更できるようにする


## アドオンを作成する

[1-5節](../chapter_01/05_Install_Own_Add-on.html) を参考にして次のソースコードを入力し、ファイル名 `sample_3-7.py` として保存してください。

[@include-source pattern="full" filepath="chapter_03/sample_3-7.py"]


# アドオンを使用する

## アドオンを有効化する

[1-5節](../chapter_01/05_Install_Own_Add-on.html) を参考にして作成したアドオンを有効化すると、コンソールウィンドウに文字列が出力されます。

```
サンプル 3-7: アドオン『サンプル 3-7』が有効化されました。
```

アドオンを有効化し、アドオンの設定情報が表示されることを確認します。

![](../../images/chapter_03/07_Use_Preference/enable_add-on.png "サンプルアドオン 3-7 アドオン有効化")


## アドオンの機能を使用する

有効化したアドオンの機能を使い、動作を確認します。


<div class="work"></div>

|||
|---|---|
|1|プリファレンスのアドオン設定情報から、フォントサイズや描画位置を変更します。<br>![](../../images/chapter_03/07_Use_Preference/use_add-on_1.png "サンプルアドオン3-7 手順1")|
|2|[3-5節](05_Draw_Texts.html) の機能によって描画されるテキストが、1で設定した内容にしたがって変化することを確認します。<br>![](../../images/chapter_03/07_Use_Preference/use_add-on_2.png "サンプルアドオン3-7 手順2")|


## アドオンを無効化する

[1-5節](../chapter_01/05_Install_Own_Add-on.html) を参考にして有効化したアドオンを無効化すると、コンソールウィンドウに文字列が出力されます。

```
サンプル 3-7: アドオン『サンプル 3-7』が無効化されました。
```


# ソースコードの解説

本節のサンプルアドオンは、[3-5節](05_Draw_Texts.html) のサンプルアドオンを改造したものです。
このため、プリファレンスにアドオンの設定情報を追加し、アドオンの動作に反映させる方法のみを説明します。
その他の処理については、[3-5節](05_Draw_Texts.html) を参照してください。


## アドオン設定情報クラスの定義

プリファレンスにアドオンの設定情報を追加するためには、`bpy.types.AddonPreferences` クラスを継承したクラス（**アドオン設定情報クラス** と呼ぶことにします）を定義する必要があります。

[@include-source pattern="partial" filepath="chapter_03/sample_3-7.py" block="addon_prefs", unindent="True"]


アドオン設定情報クラスのクラス変数 `bl_idname` には、プリファレンスに追加するアドオンの設定情報に対応した、パッケージ名やモジュール名を指定します。
アドオンのソースコードが単一のファイルで構成される場合は、自身のモジュール名を表す `__name__` を指定します。
一方、アドオンのソースコードが複数のファイルで構成される場合は、パッケージ名を指定する必要がありますが、指定方法について注意する必要があります。
アドオン設定情報クラスが `__init__.py` に定義されている場合は、`__name__` がパッケージ名を表すため `__name__` を指定すれば問題ありません（`__package__` を指定してもよいです）。
しかし、`__init__.py` 以外に定義されている場合は、パッケージ名を表す `__package__` を指定する必要があります。

プリファレンスに追加するアドオンの設定情報は、プロパティクラスの変数としてクラス変数に定義します。
そして、アドオン設定情報クラスの `draw` メソッドに、UIを構築するための処理を定義します。
`draw` メソッドの書き方は、基本的にパネルクラスの `draw` メソッドの書き方と同じです。
しかし、`row.prop` メソッドなどのUIを追加する関数の第1引数には、プロパティクラスの変数を定義したインスタンスを指定する必要があることに注意が必要です。
サンプルアドオンでは、`draw` メソッドが呼び出されたインスタンスと、プロパティクラスの変数を定義したインスタンスが同じであることから、`self` を指定します。

ここまでの処理で、プリファレンスにアドオンの設定情報が追加できます。
続いて、プリファレンスに追加したアドオンの設定情報を、オペレータクラスの処理内で受け取る方法を説明します。


## アドオンの設定情報へのアクセス

アドオンの設定情報へは、次のコードでアクセスできます。

[@include-source pattern="partial" filepath="chapter_03/sample_3-7.py" block="get_prefs", unindent="True"]

本節のサンプルアドオンのソースコードは、単一のファイルで構成されます。
このため、`context.preferences.addons[__name__].preferences` でアドオンの設定情報にアクセスできます。
アドオンが複数のファイルで構成されている場合は、前述のアドオン設定情報クラスと同様に `bl_idname` に `__name__` または `__package__` を指定して、アドオンの設定情報にアクセスします。

これで、プリファレンスに追加されたアドオンの設定情報にアクセスできるようになりました。
アドオンの設定情報を使ってテキストを描画する処理を、次に示します。

[@include-source pattern="partial" filepath="chapter_03/sample_3-7.py" block="refer_prefs", unindent="True"]


# まとめ

プリファレンスにアドオンの設定情報を配置し、設定された情報を取得する方法を紹介しました。
プリファレンスを活用することで、SidebarやオペレータプロパティのUIが煩雑になる問題を解消できます。
プリファレンスに配置する設定情報の選択基準を決めるのは難しいところがありますが、設定情報の変更の頻度が1つの基準になるかと思います。

本節までで、BlenderのUIフレームワークの中でUIを構築する方法が、何度か出てきました。
幸いなことに、対象がSidebarであるかプリファレンスであるかに関わらず、基本的には同じような方法でUIを構築できます。
一度覚えたことを他の場面でも活用できるのは、BlenderのUIが一貫した方法で構築されているからです。
なお、UIの構築については、[2-7節](../chapter_02/07_Control_Blender_UI.html) にて詳細に説明しているため、参考にしてください。


## ポイント

* アドオンごとに設定情報や詳細情報を表示するためのUIが、プリファレンスに用意されている
* 頻繁に変更する設定をSidebarやオペレータプロパティに配置し、その他はプリファレンスに配置するなど、設定内容に応じてアドオンの設定情報を配置する場所を決めよう
* プリファレンスにアドオンの設定情報を配置するためには、`bpy.types.AddonPreferences` クラスを継承したアドオン設定情報クラスを定義する必要がある
* アドオンの設定情報を定義するためには、アドオン設定情報クラスのクラス変数にプロパティクラスの変数として定義し、UIを `draw` メソッドで定義する
* プリファレンスのアドオンの設定情報は、モジュール名やパッケージ名を `context.preferences.addons` のキーに指定することで参照できる
