---
pagetitle: 2-4. サブメニューを作成する
subtitle: 2-4. サブメニューを作成する
---

ここまで紹介したアドオンは、1階層のメニューに対して項目を追加するだけでしたが、サブメニュー（マウスオーバーすると展開されるメニュー）を作成して2階層以上のメニューを作ることもできます。
例えば、*[3Dビューポート]* スペースのメニュー *[追加]* > *[メッシュ]* は、親メニュー *[追加]* の下に子メニュー *[メッシュ]* がある2階層のメニューとなっています。
本節では、[2-3節](03_Use_Operator_Property.html) のサンプルアドオンを改良し、並進移動するオブジェクトをメニューから選択できるようにします。
そして、このサンプルアドオンを説明しながら、多階層のメニューを作成する方法を解説します。


# 作成するアドオンの仕様

* [2-3節](03_Use_Operator_Property.html) で作成したサンプルアドオンを改良し、並進移動するオブジェクトをメニューから選択できるようにする


# アドオンを作成する

[1-5節](../chapter_01/05_Install_Own_Add-on.html) を参考にして次に示すソースコードを入力し、ファイル名を `sample_2-4.py` で保存してください。

[@include-source pattern="full" filepath="chapter_02/sample_2-4.py"]


# アドオンを使用する


## アドオンを有効化する

[1-5節](../chapter_01/05_Install_Own_Add-on.html) を参考にして作成したアドオンを有効化すると、コンソールウィンドウに次の文字列が出力されます。

```
サンプル 2-4: アドオン『サンプル 2-4』が有効化されました。
```

アドオンを有効化したあと、*[3Dビューポート]* スペースのメニュー *[オブジェクト]* > *[オブジェクトの並進移動]* にサブメニューが追加されていることを確認します。
サブメニューには、*[3Dビューポート]* スペースに存在するメッシュ型のオブジェクト名の項目が追加されています。
なお、Blenderを日本語化している場合、自動翻訳により「Cube」は「立方体」と表示されるため、注意してください。

![](../../images/chapter_02/04_Create_Sub-menu/enable_add-on.png "サンプルアドオン2-4 有効化")


## アドオンの機能を使用する

<div class="work"></div>

|||
|---|---|
|1|*[3Dビューポート]* スペースのメニュー *[オブジェクト]* > *[オブジェクトの並進移動]* から、並進移動するオブジェクトの名前を選んで実行すると、選択したオブジェクトが並進移動します。|
|2|[2-3節](03_Use_Operator_Property.html) と同様、並進移動時の移動軸・移動量を、オペレータプロパティから変更できます。<br>![](../../images/chapter_02/04_Create_Sub-menu/use_add-on_2.png "サンプルアドオン2-4 手順2")|


## アドオンを無効化する

[1-5節](../chapter_01/05_Install_Own_Add-on.html) を参考にして有効化したアドオンを無効化すると、コンソールウィンドウに次の文字列が出力されます。

```
サンプル 2-4: アドオン『サンプル 2-4』が無効化されました。
```


# ソースコードの解説

ソースコードの大部分は [2-3節](03_Use_Operator_Property.html) からの流用です。
ここでは、新規で追加した部分について解説します。


## サブメニューの追加

サブメニューを追加するためには、`bpy.types.Menu` クラスを継承した **メニュークラス** を作成する必要があります。

[@include-source pattern="partial" filepath="chapter_02/sample_2-4.py" block="menu_cls", unindent="True"]

オペレータクラスと同様、メニュークラスにはクラス変数 `bl_idname` , `bl_label` , `bl_description` を定義する必要がありますが、`bl_options` を定義する必要はありません。
ただし `bl_idname` は、メニュークラスのクラス名と同一の文字列を指定する必要があります。
メニュークラスのクラス名は、フォーマット` XXX_MT_YYY` にしたがう必要があります。
`XXX` は英大文字から始まる英字/数字/アンダースコア（`_`）から構成される文字列、`YYY` は英字/数字/アンダースコア（`_`）から構成される文字列です。

また、メニュークラスでは、メニューの描画に必要な `draw` メソッドを実装する必要があります。
メニューが表示されるたびに `draw` メソッドが呼ばれ、次の引数が渡されてきます。

|引数|型|値の説明|
|---|---|---|
|`self`|メニュークラス|メニュークラスのインスタンス|
|`context`|`bpy.types.Context`|`draw` メソッドが呼ばれたときのコンテキスト|

サブメニューへの項目追加は `self.layout.operator` メソッドで行います。
本節のサンプルアドオンでは、*[3Dビューポート]* スペース上の全てのオブジェクト名をメニュー項目に追加するため、`self.layout.operator` メソッドの第1引数にオペレータクラスのクラス変数 `bl_idname` を指定し、引数 `text` にオブジェクト名を指定しています。

オペレータクラス `SAMPLE24_OT_TranslateObject` は、並進移動するオブジェクトをオブジェクト名で判定するため、オペレータクラスのクラス変数 `obj_name` にオブジェクト名を代入します。
`obj_name` は `StringProperty` クラスとして定義します。
なお、引数 `options` に値 `{'HIDDEN'}` を渡していますが、これはオペレータプロパティとしてユーザに変更を許したくないプロパティに対して設定します。
これにより `obj_name` がオペレータプロパティとして表示されなくなります。

[@include-source pattern="partial" filepath="chapter_02/sample_2-4.py" block="string_prop", unindent="True"]

オペレータクラスの `execute` メソッドでは、クラス変数 `obj_name` に代入されたオブジェクト名を用いて、並進移動の対象となるオブジェクトを取得して並進移動させています。
なお、詳細を省略した `execute` メソッドの具体的な処理については、ソースコードのコメントに処理内容を細かく記載しているため、確認してみてください。

最後に、*[3Dビューポート]* スペースのメニュー *[オブジェクト]* にメニューを追加します。

[@include-source pattern="partial" filepath="chapter_02/sample_2-4.py" block="build_menu", unindent="True"]

オペレータをメニューに追加するときは、`self.layout.operator` メソッドを利用していました。
しかし、サブメニューをメニューに追加する場合は、`self.layout.menu` メソッドを利用する必要があります。
`self.layout.menu` メソッドにメニュークラス `SAMPLE24_MT_TranslateObject` クラスのクラス変数 `bl_idname` を引数として渡すことで、サブメニューをメニューに追加できます。


## 3階層以上のメニュー

サブメニューにさらにサブメニュー（サブサブメニュー）を追加するなど、3階層以上のメニューを作成することもできます。

次のコードは、先ほど作成したサンプルアドオンのメニューとサブメニューの間に、新たなメニューとして *[オブジェクトの並進移動（サブメニュー）]* を追加する処理です。

[@include-source pattern="full" filepath="chapter_02/sample_2-4_alt.py"]

アドオンを作成して有効化すると、図のように3階層のメニューが作成されていることが確認できます。

![](../../images/chapter_02/04_Create_Sub-menu/multilevel_menu.png "多階層メニュー")

コードを見るとわかると思いますが、3階層のメニューは2階層のメニューを作成したときの応用です。

[@include-source pattern="partial" filepath="chapter_02/sample_2-4_alt.py" block="sub_menu_cls", unindent="True"]

[@include-source pattern="partial" filepath="chapter_02/sample_2-4_alt.py" block="main_menu_cls", unindent="True"]

メニュークラス `SAMPLE24_MT_TranslateObject` では、サブサブメニュー用に作成したメニュークラス `SAMPLE24_MT_TranslateObjectSub` のクラス変数 `bl_idname` を、`self.layout.menu` メソッドに渡しています。
そして、`SAMPLE24_MT_TranslateObjectSub` クラスの中でオペレータを登録することで、3階層のメニューを作成しています。

同様の手順を踏むことで、4階層、5階層、・・・とメニューの階層を増やすことができます。


# まとめ

[2-3節](03_Use_Operator_Property.html) で紹介したサンプルアドオンを改造し、並進移動するオブジェクトをサブメニューから選択できるようにしました。

サブメニューを用いることで、本節のサンプルアドオンのように処理対象を選択できるようにしたり、機能ごとにメニュー項目を整理できるようになります。
ぜひここでサブメニューの作り方を習得し、わかりやすいUI作りに活かしましょう。


## ポイント

* メニュークラスは、`bpy.types.Menu` クラスを継承して作成する
* メニュークラスのクラス変数 `bl_idname` を引数にして `self.layout.menu` メソッドを呼び出し、そのメニュークラスの `draw` メソッド内で、オペレータクラスのクラス変数 `bl_idname ` を `self.layout.operation` メソッドの引数に指定することで、サブメニューを作成できる
* メニュークラスや `self.layout.menu` メソッドを活用することで、3階層以上のメニューを作成できる
